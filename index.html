<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TV+</title>
  <link rel="icon" href="TV.png" />
  <style>
    :root {
      --primary: #e50914;
      --primary-hover: #f40612;
      --bg: #121212;
      --card-bg: #1f1f1f;
      --text: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #666;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(0,0,0,0.5);
      --success: #4ade80;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      position: relative;
    }

    .top-bar {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
    }

    .logo-small {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .follow-btn {
      background: var(--primary);
      color: white;
      text-decoration: none;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 600;
      transition: background 0.2s;
    }

    .follow-btn:hover {
      background: var(--primary-hover);
      text-decoration: none;
    }

    h1 {
      font-size: 1.8em;
      margin: 10px 0;
      text-align: center;
    }

    .filters {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      flex-wrap: wrap;
      justify-content: center;
    }

    .filter-btn {
      padding: 10px 20px;
      font-size: 1em;
      background: #333;
      color: var(--text-secondary);
      border: 1px solid #444;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .status-bar {
      font-size: 0.85em;
      color: var(--text-muted);
      margin-top: 4px;
      text-align: center;
      min-height: 1.4em;
    }

    .countdown {
      font-weight: bold;
      color: var(--success);
    }

    .movie-card {
      background: var(--card-bg);
      max-width: 600px;
      width: 100%;
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      margin-top: 16px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .movie-card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .movie-poster {
      max-width: 100%;
      border-radius: var(--radius);
      display: block;
      margin: 0 auto 16px;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: #333;
    }

    .movie-title {
      font-size: 1.6em;
      margin: 12px 0;
      font-weight: 600;
    }

    .movie-overview {
      font-size: 1em;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    button.action-btn {
      padding: 12px 24px;
      font-size: 1em;
      margin-top: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 4px 12px rgba(229, 9, 20, 0.3);
    }

    button.action-btn:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: scale(1.03);
    }

    button.action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      font-size: 1.3em;
      margin-top: 30px;
      color: var(--text-secondary);
      display: none;
    }

    .error {
      color: #ff6b6b;
      padding: 16px;
      background: rgba(255, 107, 107, 0.1);
      border-radius: var(--radius);
      margin-top: 20px;
    }

    .notification-fallback {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--card-bg);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-size: 0.95em;
      max-width: 300px;
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
    }

    .notification-fallback.show {
      opacity: 1;
      transform: translateY(0);
    }

    .watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      color: rgba(255, 255, 255, 0.3);
      font-size: 0.8em;
      pointer-events: none;
      z-index: 999;
    }

    @media (max-width: 600px) {
      .filter-btn { padding: 8px 16px; font-size: 0.9em; }
      .movie-title { font-size: 1.4em; }
      h1 { font-size: 1.5em; }
      .action-btn { padding: 10px 20px; font-size: 0.95em; }
      .top-bar { top: 12px; left: 12px; }
      .logo-small { width: 28px; height: 28px; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <img src="TV.png"
         alt="Logo"
         class="logo-small">
    <a href="https://whatsapp.com/channel/0029Vb6sN8kL7UVSCeAQgA2f"
       target="_blank"
       rel="noopener noreferrer"
       class="follow-btn">Seguir</a>
  </div>

  <h1>TV+</h1>

  <div class="filters">
    <button class="filter-btn active" data-type="movie">Películas (este año)</button>
    <button class="filter-btn" data-type="tv">Series (en emisión y próximas)</button>
  </div>

  <div class="status-bar" aria-live="polite">
    <span id="last-update"></span> • Próxima actualización: <span id="countdown" class="countdown">--:--</span>
  </div>

  <button id="load-btn" class="action-btn">¿QUÉ VER? +</button>

  <div id="loading" class="loading">Cargando...</div>
  <div id="movie-container" class="movie-card"></div>

  <div id="notification-fallback" class="notification-fallback"></div>
  <div class="watermark">TV_RM</div>

  <script>
    const CONFIG = {
      API_KEY: '487ec2ee423ac20f42f80d2ee5aebab8',
      BASE_URL: 'https://api.themoviedb.org/3',
      IMG_BASE_URL: 'https://image.tmdb.org/t/p/w500',
      MAX_RETRIES: 3,
      INITIAL_DELAY: 1000,
      AUTO_UPDATE_INTERVAL: 60 * 60 * 1000,
    };

    const State = {
      currentType: 'movie',
      currentAbortController: null,
      autoUpdateTimer: null,
      lastUpdate: null,
      isPageVisible: true,
      isLoading: false,
      lastItem: null,
      cache: { movie: [], tv: [] },
      cacheExpiry: { movie: 0, tv: 0 },
    };

    function cleanup() {
      if (State.currentAbortController) {
        State.currentAbortController.abort();
        State.currentAbortController = null;
      }
      if (State.autoUpdateTimer) {
        clearTimeout(State.autoUpdateTimer);
        State.autoUpdateTimer = null;
      }
    }

    function formatTime(date) {
      return new Intl.DateTimeFormat('es-ES', {
        hour: '2-digit',
        minute: '2-digit'
      }).format(date);
    }

    function showFallbackNotification(message) {
      const el = document.getElementById('notification-fallback');
      el.textContent = message;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 5000);
    }

    async function requestNotificationPermission() {
      if (!("Notification" in window)) return false;
      if (Notification.permission === "granted") return true;
      if (Notification.permission === "denied") return false;
      return (await Notification.requestPermission()) === "granted";
    }

    function showNotification(title, body) {
      if (Notification.permission === "granted") {
        new Notification(title, {
          body,
          icon: 'https://www.themoviedb.org/assets/2/apple-touch-icon-cfba7699efe7a742de25c28e08c38525f19381d31087c69e89d6bcb8e3c0ddfa.png'
        });
      } else {
        showFallbackNotification(body);
      }
    }

    function updateCountdown() {
      if (!State.lastUpdate) return;
      const next = new Date(State.lastUpdate.getTime() + CONFIG.AUTO_UPDATE_INTERVAL);
      const now = new Date();
      if (next <= now) {
        document.getElementById('countdown').textContent = '--:--';
        return;
      }
      const diff = next - now;
      const mins = Math.floor(diff / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      document.getElementById('countdown').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      setTimeout(updateCountdown, 1000);
    }

    async function fetchWithRetry(url, retries = CONFIG.MAX_RETRIES, delay = CONFIG.INITIAL_DELAY) {
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await fetch(url, {
            signal: State.currentAbortController?.signal,
            headers: { Accept: 'application/json' }
          });
          if (!res.ok) {
            if (res.status === 429 && i < retries) {
              await new Promise(r => setTimeout(r, delay * (2 ** i)));
              continue;
            }
            throw new Error(`HTTP ${res.status}`);
          }
          return await res.json();
        } catch (err) {
          if (err.name === 'AbortError') throw err;
          if (i === retries) throw err;
          await new Promise(r => setTimeout(r, delay * (2 ** i)));
        }
      }
    }

    const CURRENT_YEAR = new Date().getFullYear();

    async function fetchMoviesThisYear() {
      const now = Date.now();
      if (State.cache.movie.length > 0 && now < State.cacheExpiry.movie) {
        return State.cache.movie;
      }

      const data = await fetchWithRetry(
        `${CONFIG.BASE_URL}/discover/movie?api_key=${CONFIG.API_KEY}&primary_release_year=${CURRENT_YEAR}&sort_by=popularity.desc&language=es-ES`
      );
      const valid = data.results.filter(m =>
        m.poster_path && m.title && m.release_date && new Date(m.release_date).getFullYear() === CURRENT_YEAR
      );
      State.cache.movie = valid;
      State.cacheExpiry.movie = now + 10 * 60 * 1000;
      return valid;
    }

    async function fetchTVCurrentAndUpcoming() {
      const now = Date.now();
      if (State.cache.tv.length > 0 && now < State.cacheExpiry.tv) {
        return State.cache.tv;
      }

      const [onAir, upcoming] = await Promise.all([
        fetchWithRetry(`${CONFIG.BASE_URL}/tv/on_the_air?api_key=${CONFIG.API_KEY}&language=es-ES&page=1`),
        fetchWithRetry(`${CONFIG.BASE_URL}/tv/upcoming?api_key=${CONFIG.API_KEY}&language=es-ES&page=1`)
      ]);

      const valid = [...(onAir.results || []), ...(upcoming.results || [])].filter(s => s.poster_path && s.name);
      State.cache.tv = valid;
      State.cacheExpiry.tv = now + 10 * 60 * 1000;
      return valid;
    }

    async function getRandomContent(type) {
      let items = [];
      if (type === 'movie') {
        items = await fetchMoviesThisYear();
      } else if (type === 'tv') {
        items = await fetchTVCurrentAndUpcoming();
      }
      if (items.length === 0) {
        throw new Error(type === 'movie'
          ? `No hay películas de estreno en ${CURRENT_YEAR}.`
          : 'No hay series en emisión ni próximas.'
        );
      }
      return items[Math.floor(Math.random() * items.length)];
    }

    function renderContent(item, type) {
      const container = document.getElementById('movie-container');
      container.innerHTML = '';

      const img = document.createElement('img');
      img.className = 'movie-poster';
      img.src = `${CONFIG.IMG_BASE_URL}${item.poster_path}`;
      img.alt = type === 'movie' ? `Póster de ${item.title}` : `Póster de ${item.name}`;
      img.loading = 'lazy';

      const title = document.createElement('div');
      title.className = 'movie-title';
      const name = type === 'movie' ? item.title : item.name;
      const year = type === 'movie'
        ? (item.release_date ? item.release_date.substring(0, 4) : 'N/A')
        : (item.first_air_date ? item.first_air_date.substring(0, 4) : 'N/A');
      title.textContent = `${name} (${year})`;

      const overview = document.createElement('p');
      overview.className = 'movie-overview';
      overview.textContent = item.overview || 'Sin descripción disponible.';

      container.appendChild(img);
      container.appendChild(title);
      container.appendChild(overview);
      container.classList.add('visible');

      State.lastItem = { item, type };
    }

    function renderError(message) {
      const container = document.getElementById('movie-container');
      container.innerHTML = '';
      const err = document.createElement('div');
      err.className = 'error';
      err.textContent = `❌ ${message}`;
      container.appendChild(err);
      container.classList.add('visible');
    }

    async function loadContent(isAuto = false) {
      if (!State.isPageVisible && isAuto) return;
      if (State.isLoading) return;

      State.isLoading = true;

      const btn = document.getElementById('load-btn');
      const loading = document.getElementById('loading');
      const container = document.getElementById('movie-container');

      cleanup();
      State.currentAbortController = new AbortController();

      btn.disabled = true;
      loading.style.display = 'block';
      container.classList.remove('visible');

      let item;
      try {
        item = await getRandomContent(State.currentType);
        renderContent(item, State.currentType);

        State.lastUpdate = new Date();
        document.getElementById('last-update').textContent = `Última: ${formatTime(State.lastUpdate)}`;
        updateCountdown();

        if (isAuto && State.lastItem) {
          const isNew = !State.lastItem ||
            (State.lastItem.type !== State.currentType) ||
            (State.lastItem.item.id !== item.id);
          if (isNew) {
            await requestNotificationPermission();
            const title = State.currentType === 'movie' ? 'Nueva película de estreno' : 'Nueva serie sugerida';
            showNotification(`🎬 ${title}`, `"${State.currentType === 'movie' ? item.title : item.name}"`);
          }
        }
      } catch (error) {
        console.error('Error:', error);
        if (State.lastItem && !isAuto) {
          renderContent(State.lastItem.item, State.lastItem.type);
        } else {
          renderError(error.message || 'No se pudo cargar contenido.');
        }
      } finally {
        loading.style.display = 'none';
        btn.disabled = false;
        State.isLoading = false;
        if (isAuto) scheduleAutoUpdate();
      }
    }

    function scheduleAutoUpdate() {
      cleanup();
      State.autoUpdateTimer = setTimeout(() => loadContent(true), CONFIG.AUTO_UPDATE_INTERVAL);
      updateCountdown();
    }

    let visibilityDebounce = null;
    document.addEventListener('visibilitychange', () => {
      State.isPageVisible = !document.hidden;
      if (visibilityDebounce) clearTimeout(visibilityDebounce);
      if (State.isPageVisible && State.lastUpdate) {
        visibilityDebounce = setTimeout(() => {
          const elapsed = Date.now() - State.lastUpdate.getTime();
          const remaining = Math.max(0, CONFIG.AUTO_UPDATE_INTERVAL - elapsed);
          if (!State.autoUpdateTimer) {
            State.autoUpdateTimer = setTimeout(() => loadContent(true), remaining);
          }
        }, 300);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.classList.contains('active')) return;
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          State.currentType = btn.dataset.type;
          loadContent(false);
        });
      });

      document.getElementById('load-btn').addEventListener('click', () => loadContent(false));

      loadContent(false);
    });

    window.addEventListener('beforeunload', cleanup);
  </script>
</body>
</html>